<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.nlog-project.org/schemas/NLog.xsd NLog.xsd"
      autoReload="true"
      throwExceptions="false"
      internalLogLevel="Off">

  <variable name="AppName" value="${processname}"/>
  <variable name="LogDirectory" value="${basedir}/Logs/${assembly-version}/"/>

  <targets async="true">
    <target name="FileLogger"
            xsi:type="File"
            fileName="${LogDirectory}/${AppName}.${date:format=yyyy_MM_dd_HH_mm:cached=true}.colibri"
            archiveFileName="${LogDirectory}/Archive/${AppName}.{##}.colibri"
            createDirs="true"
            encoding="utf-8"
            maxArchiveFiles="56"
            archiveAboveSize="26214400"
            archiveNumbering="Rolling"
            concurrentWrites="true"
            keepFileOpen="true"
            openFileCacheTimeout="30"
            archiveOldFileOnStartup="true">
      <layout xsi:type="CsvLayout" delimiter="Tab" withHeader="true" quoting="All">
        <column name="num" layout="${counter}" />
        <column name="date" layout="${date:format=yyyy-MM-dd HH\:mm\:ss.fff::culture=en-US}" />
        <column name="callsite" layout="${callsite:className=true:fileName=true:methodName=true:includeSourcePath=false:cleanNamesOfAnonymousDelegates=true:skipFrames=4}" />
        <column name="level" layout="${level:upperCase=true}"/>
        <column name="thread" layout="${threadid}"/>
        <column name="logger" layout="${logger}" />
        <column name="ndc" layout="${ndc}" />
        <column name="message" layout="${message}" />
        <column name="exception" layout="${exception:format=ToString:innerFormat=ToString}"/>
        <column name="stacktrace" layout="${stacktrace:topFrames=10:skipFrames=4}" />
      </layout>

    </target>

    <target name="ExceptionLogger"
            xsi:type="FilteringWrapper"
            condition="length('${exception}')>0">
              <target xsi:type="File"
                      fileName="${LogDirectory}/${AppName}.${date:format=yyyyMMddHHmmss:cached=true}.Errors.colibri"
                      archiveFileName="${LogDirectory}/Archive/${AppName}.{##}.Errors.colibri"
                      createDirs="true"
                      encoding="utf-8"
                      maxArchiveFiles="56"
                      archiveAboveSize="26214400"
                      archiveNumbering="Rolling"
                      concurrentWrites="true"
                      keepFileOpen="true"
                      openFileCacheTimeout="30"
                      archiveOldFileOnStartup="true">
                <layout xsi:type="CsvLayout" delimiter="Tab" withHeader="true" quoting="All">
                  <column name="num" layout="${counter}" />
                  <column name="date" layout="${date:format=yyyy-MM-dd HH\:mm\:ss.fff::culture=en-US}" />
                  <column name="callsite" layout="${callsite:className=true:fileName=true:methodName=true:includeSourcePath=false:cleanNamesOfAnonymousDelegates=true:skipFrames=4}" />
                  <column name="level" layout="${level:upperCase=true}"/>
                  <column name="thread" layout="${threadid}"/>
                  <column name="logger" layout="${logger}" />
                  <column name="ndc" layout="${ndc}" />
                  <column name="message" layout="${message}" />
                  <column name="exception" layout="${exception:format=ToString:innerFormat=ToString}"/>
                  <column name="stacktrace" layout="${stacktrace:topFrames=10:skipFrames=4}" />
                </layout>
                </target>
    </target>

    <target name="EventLogLoggger"
            xsi:type="EventLog"
            log="Application"
            source="Colibri"
            onOverflow="Truncate">
            <layout xsi:type="JsonLayout">
                  <attribute name="processname" layout="${processname:fullName=true}" />
                  <attribute name="num" layout="${counter}" />
                  <attribute name="date" layout="${date:format=yyyy-MM-dd HH\:mm\:ss.fff::culture=en-US}" />
                  <attribute name="callsite" layout="${callsite:className=true:fileName=true:methodName=true:includeSourcePath=false:cleanNamesOfAnonymousDelegates=true:skipFrames=4}" />
                  <attribute name="level" layout="${level:upperCase=true}"/>
                  <attribute name="thread" layout="${threadid}"/>
                  <attribute name="logger" layout="${logger}" />
                  <attribute name="ndc" layout="${ndc}" />
                  <attribute name="message" layout="${message}" />
                  <attribute name="exception" layout="${exception:format=ToString:innerFormat=ToString}"/>
                  <attribute name="stacktrace" layout="${stacktrace:topFrames=10:skipFrames=4}" />
              </layout>
    </target>

    <target name="ConsoleLogger"
            xsi:type="ColoredConsole"
            useDefaultRowHighlightingRules="true"
            detectConsoleAvailable="true">
            <layout xsi:type="CsvLayout" delimiter="Pipe" withHeader="false" quoting="Nothing">
                  <column name="date" layout="${date:format=yyyy-MM-dd HH\:mm\:ss.fff::culture=en-US}" />
                  <column name="callsite" layout="${callsite:className=true:fileName=true:methodName=true:includeSourcePath=false:cleanNamesOfAnonymousDelegates=true:skipFrames=4}" />
                  <column name="level" layout="${level:upperCase=true}"/>
                  <column name="thread" layout="${threadid}"/>
                  <column name="logger" layout="${logger}" />
                  <column name="ndc" layout="${ndc}" />
                  <column name="message" layout="${message}" />
                  <column name="exception" layout="${exception:format=ToString:innerFormat=ToString}"/>
            </layout>
    </target>

    <target name="NetworkLogger"
            xsi:type="NLogViewer"
            includeSourceInfo="true"
            includeNdc="true"
            address="udp://127.0.0.1:9999"/>
  </targets>
  <rules>
    <logger name="*" minlevel="Trace" writeTo="FileLogger,NetworkLogger,ExceptionLogger,ConsoleLogger" />
    <logger name="*" minlevel="Warn" writeTo="EventLogLoggger" />
  </rules>
</nlog>
